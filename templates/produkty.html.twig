{% extends "layout.html.twig" %}

{% block content %}
    <div class="container theme-showcase" role="main">

        <div class="page-header">
            <h1>Edycja Katalogu Produktów</h1>
        </div>
        
        <div class="container" style="margin-top:30px;">
                                <div class="row">
                                    <ul id="katalog">
                                        <li><a href="#">Katalog</a> 
                                        <button id="0" href="#product" type="button" 
                                                class="btn btn-xs btn-warning" data-toggle="modal">[ Nowa Kategoria ]
                                        </button>

                                            {% macro productMacro(array) %}
                                                {% import _self as pmacro %}
                                                <ul>
                                                    {% for product in array %}

                                                        {% if product.product_is_active %}
                                                            <li title="{{ product.product_desc }}">

                                                                {{ product.product_name }}

                                                                {% if not product.product_is_category %}

                                                                    {{ (product.product_base_value/100)|number_format(2, '.', ',') }} zł / {{ product.product_base_size }}

                                                                    <button id="{{ product.product_id }}" type="button"
                                                                            onclick="edit_item({{ product.product_id }},1)"
                                                                            class="btn btn-xs btn-success">[ edytuj ]
                                                                    </button>
                                                                    <button id="{{ product.product_id }}" type="button"
                                                                            onclick="edit_item({{ product.product_id }},1)"
                                                                            class="btn btn-xs btn-danger">[ usuń ]
                                                                    </button>
                                                                {% else %}

                                                                    <button id="{{ product.product_id }}" type="button"
                                                                            onclick="add_item({{ product.product_id }},1)"
                                                                            class="btn btn-xs btn-warning">[ Nowa SubKategoria ]
                                                                    </button>

                                                                    <button id="{{ product.product_id }}" type="button"
                                                                            onclick="add_item({{ product.product_id }},1)"
                                                                            class="btn btn-xs btn-success">[ Nowy Produkt ]
                                                                    </button>

                                                                {% endif %}

                                                                {% if not product.children|default([]) is empty %}

                                                                    {{ pmacro.productMacro(product.children) }}

                                                                {% endif %}
                                                            </li>
                                                        {% endif %}
                                                    {% endfor %}
                                                </ul>
                                            {% endmacro %}

                                            {% import _self as pmacro2 %}
                                            {{ pmacro2.productMacro(products) }}

                                        </li>
                                    </ul>
                                    <p>

                                    </p>
                                </div>
                            </div>

    </div> <!-- /container -->

<!-- /Modal Nowego Produktu / Kategorii -->
    <div id="product" class="modal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Tworzenie / Edycja Kategorii i produktów</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="product_form">
                    <!-- Reload for with product -->
                </div>
                <div class="modal-footer">
                    <button id="user-confirm-btn" type="button" class="btn btn-primary">Zatwierdź</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Anuluj</button>
                </div>
            </div>
        </div>
    </div>
    <!-- /Modal Nowego Użytkownika -->

    

{% endblock %}

{% block scripts %}
    <script src="{{ asset('js/treeview.js') }}"></script>
    <script>
        $('#katalog').treed({openedClass: 'glyphicon-folder-open', closedClass: 'glyphicon-folder-close', unfolded: true});

        $('#product').on('show.bs.modal', function(e) {
            $.post("{{ url('product_show') }}", {}, function(data, status) {
                $("#product_form").html(data);
            });

            //if (!data) return e.preventDefault() // stops modal from being shown
        });

        $('#order-confirm-btn').on('click', function() {
            $.post(
                "{{ url('product_show') }}",
                $('#order-form').serialize()
            ).done(function(data) {
                $('#neworder').modal('hide');
                location.reload();
            });
        });

        $('#order-confirm-btn').on('click', function() {
            $.post(
                "{{ url('zamowienia_save') }}",
                $('#order-form').serialize()
            ).done(function(data) {
                $('#neworder').modal('hide');
                location.reload();
            });
        });

        function add_order_item(i_id, i_amount) {
            $.post("{{ url('zamowienia_add_item') }}", {
                item_id: i_id,
                item_count: i_amount,
                update_record: 1
            }).done(function(data) {
                let amountElem = $('#item-amount-' + i_id);

                if (amountElem.length > 0) {
                    let amount = amountElem.val();
                    amountElem.val(parseInt(amount) + i_amount);
                    saveOrder();
                } else {
                    refreshItems();
                }
            });
        }

        function remove_order_item(i_id) {
            $.post("{{ url('zamowienia_add_item') }}", {
                item_id: i_id,
                remove: i_id
            }, function(data, status) {
                setTimeout(function() {
                    $.post("{{ url('zamowienia_show') }}", {}, function(data, status) {
                        $("#zamowienie").html(data)
                    });
                }, 100);

            });

        }

        $('#zamowienie').on('focusout', 'input.item-amount', saveOrder);

        function saveOrder() {
            $('button.save-item-btn').trigger('click');
        }

        function save_order_item(i_id) {
            $.post("{{ url('zamowienia_add_item') }}", {
                item_id: i_id,
                item_count: $('#item-amount-' + i_id).val()
            }).done(function(data) {
                $.post("{{ url('zamowienia_show') }}", {}, function(data, status) {
                    $("#zamowienie").html(data)
                });
            });
        }

        function refreshItems() {
            $.post("{{ url('zamowienia_show') }}", {}, function(data, status) {
                $("#zamowienie").html(data);
            });
        }

        function showLoader() {
            $("#zamowienie").html('<tr><td colspan=6><center><img src="{{ asset('assets/img/loading.gif') }}"></center></td></tr> ');
        }

    </script>
{% endblock %}